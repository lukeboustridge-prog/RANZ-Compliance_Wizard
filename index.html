<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANZ Compliance Master Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --ranz-charcoal: #3c4b5d;
            --ranz-blue: #00417a;
            --ranz-red: #be4039;
            --ranz-yellow: #fcb613;
            --ranz-silver: #939598;
            --light-bg: #f4f7f6;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light-bg);
            color: var(--ranz-charcoal);
            margin: 0;
            padding: 0;
            line-height: 1.4; /* Tighter lines */
            height: 100vh; /* Lock height to viewport */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll, scroll content instead */
        }

        /* --- COMPACT HEADER --- */
        header {
            background-color: white;
            border-bottom: 4px solid var(--ranz-red);
            height: 80px; /* Fixed small height */
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 5%;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-logo img { height: 50px; width: auto; display: block; }
        
        .header-title { text-align: right; }
        .header-title h1 { 
            color: var(--ranz-charcoal); 
            margin: 0; 
            font-size: 1.2rem; 
            text-transform: uppercase; 
            font-weight: 800; 
        }
        .header-title p { 
            color: var(--ranz-blue); 
            margin: 0; 
            font-size: 0.8rem; 
            font-weight: 600; 
        }

        /* --- SCROLLABLE MAIN CONTENT --- */
        .main-scroll-area {
            flex: 1;
            overflow-y: auto; /* Internal scroll only */
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
        }

        .container {
            width: 100%;
            max-width: 1000px; /* Wider for side-by-side */
            margin: 0 auto;
        }

        /* --- SPLIT LAYOUT CARD --- */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 0; /* Remove default padding, handled by grid */
            display: none;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .card.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* The Grid System */
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 320px; /* Main content | Sidebar */
            min-height: 400px;
        }

        /* Left Column: Interaction */
        .card-main {
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        /* Right Column: Context/Info */
        .card-sidebar {
            background-color: #f8f9fa;
            border-left: 1px solid #eee;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        h2 {
            color: var(--ranz-blue);
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0 0 1.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }

        /* --- SIDEBAR BOXES --- */
        .info-box, .warning-box, .case-study-box, .tech-alert {
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            line-height: 1.5;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .info-box { border-left: 4px solid var(--ranz-blue); }
        .warning-box { border-left: 4px solid var(--ranz-yellow); background: #fffdf5; }
        .case-study-box { border-left: 4px solid var(--ranz-red); background: #fff5f5; }
        .tech-alert { border-left: 4px solid #2196f3; background: #f0f7ff; }

        .box-title {
            font-weight: 800;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #555;
        }

        .case-study-box .box-title { color: var(--ranz-red); }
        .case-study-box .box-title::before { content: "⚖️ CASE LAW: "; }

        .citation {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            font-style: italic;
            color: #888;
            display: block;
        }

        /* --- INPUTS --- */
        .option-group { display: grid; gap: 0.8rem; margin-bottom: auto; /* Pushes buttons down */ }

        .radio-label {
            display: block;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .radio-label:hover { border-color: var(--ranz-silver); background-color: #fafafa; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label {
            border-color: var(--ranz-blue);
            background-color: #f0f7fb;
            box-shadow: 0 0 0 1px var(--ranz-blue) inset;
        }

        .option-title { font-weight: 700; display: block; font-size: 0.95rem; margin-bottom: 2px; }
        .option-desc { font-weight: 400; font-size: 0.85rem; color: #666; }

        /* --- BUTTONS --- */
        .actions { 
            margin-top: 2rem; 
            display: grid; 
            grid-template-columns: 100px 1fr; /* Back button small, Next button big */
            gap: 1rem; 
        }
        
        .btn {
            padding: 0.8rem;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        
        .btn-next { background-color: var(--ranz-blue); color: white; }
        .btn-next:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-back { background-color: #f1f3f5; color: #333; }

        /* --- INTRO & TERMS --- */
        .terms-container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 1rem;
            font-size: 0.8rem;
            color: #555;
            height: 120px;
            overflow-y: auto;
            margin: 1rem 0;
            border-radius: 4px;
        }

        /* --- RESULTS PAGE --- */
        .result-block { padding: 2rem; }
        .result-banner { text-align: center; padding: 1.5rem; color: white; border-radius: 6px; margin-bottom: 2rem; }
        .res-consent { background-color: var(--ranz-red); }
        .res-exempt { background-color: #28a745; }
        .res-check { background-color: var(--ranz-blue); }
        .res-commercial { background-color: var(--ranz-charcoal); }

        .leg-breakdown { font-size: 0.85rem; background: #fafafa; padding: 1.5rem; border-top: 1px solid #eee; }
        .leg-item { margin-bottom: 1rem; }
        .leg-q { font-weight: 800; color: var(--ranz-blue); font-size: 0.8rem; text-transform: uppercase; }
        .leg-a { font-size: 0.9rem; margin-top: 2px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .card-grid { grid-template-columns: 1fr; } /* Stack on mobile */
            .card-sidebar { border-left: none; border-top: 1px solid #eee; background: white; padding-top: 0; }
            header { padding: 0 1rem; }
            .header-logo img { height: 40px; }
            .header-title h1 { font-size: 1rem; }
            .header-title p { font-size: 0.7rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-logo">
        <img src="logo.png" alt="RANZ Logo">
    </div>
    <div class="header-title">
        <h1>Compliance Wizard</h1>
        <p>Consent & LBP Obligations</p>
    </div>
</header>

<div class="main-scroll-area">
    <div class="container">

        <div class="card active" id="stepIntro">
            <div class="card-main"> <h2>Terms of Use</h2>
                <div style="font-size:0.95rem; margin-bottom:1rem;">
                    This tool guides Roofers and Homeowners through <strong>Building Act 2004</strong> obligations.
                </div>
                
                <div class="terms-container">
                    <p><strong>1. No Data Storage:</strong> RANZ does not see or store your data.</p>
                    <p><strong>2. Membership:</strong> Using this tool does not prove RANZ membership. Verify at ranz.co.nz.</p>
                    <p><strong>3. Not Legal Advice:</strong> This is a guide only. Consult your BCA.</p>
                </div>

                <label style="display:flex; align-items:center; gap:10px; background:#eef4f8; padding:1rem; border-radius:4px; font-size:0.9rem;">
                    <input type="checkbox" id="terms-check" style="display:block; width:18px; height:18px;">
                    <strong>I have read and accept the Terms & Conditions.</strong>
                </label>

                <div class="actions" style="grid-template-columns: 1fr;">
                    <button class="btn btn-next" id="btn-intro-start" disabled>Start Assessment</button>
                </div>
            </div>
        </div>

        <div class="card" id="step0">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Phase 1: What is your situation?</h2>
                    <div class="option-group">
                        <label><input type="radio" name="pathway" value="planning"><div class="radio-label"><span class="option-title">A. Planning & Pricing</span><span class="option-desc">"I am checking rules for a future job."</span></div></label>
                        <label><input type="radio" name="pathway" value="execution"><div class="radio-label"><span class="option-title">B. Doing the Work / Issues</span><span class="option-desc">"I am on site, managing staff, or in a dispute."</span></div></label>
                    </div>
                    <div class="actions">
                        <button class="btn btn-back" id="btn-back-0">Back</button>
                        <button class="btn btn-next" id="btn-start">Next</button>
                    </div>
                </div>
                <div class="card-sidebar">
                    <div class="info-box">
                        <span class="box-title">Why this matters</span>
                        The rules differ depending on whether you are at the <strong>Design/Consent</strong> stage or the <strong>Construction/Supervision</strong> stage.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepP1">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Step 1: The Job Scope</h2>
                    <div class="option-group">
                        <label><input type="radio" name="scope" value="new"><div class="radio-label"><span class="option-title">A. New Build / Extension</span></div></label>
                        <label><input type="radio" name="scope" value="replace_same"><div class="radio-label"><span class="option-title">B. Like-for-Like Replacement</span><span class="option-desc">Same materials, same position.</span></div></label>
                        <label><input type="radio" name="scope" value="replace_change"><div class="radio-label"><span class="option-title">C. Replacement with Changes</span><span class="option-desc">Removing parapets, changing pitch/profile.</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-p1">Back</button><button class="btn btn-next" id="btn-next-p1">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="case-study-box">
                        <span class="box-title">Design Changes</span>
                        In <em>Newton [2023]</em>, a roofer removed parapets during re-roofing. The Board ruled this was a design change, voiding the Schedule 1 exemption.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepP1_Complex">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Step 1b: Complex Scenarios</h2>
                    <div class="option-group">
                        <label><input type="radio" name="complex" value="gutter"><div class="radio-label"><span class="option-title">Internal to External Gutter</span></div></label>
                        <label><input type="radio" name="complex" value="skillion"><div class="radio-label"><span class="option-title">Skillion Roof (No Cavity)</span></div></label>
                        <label><input type="radio" name="complex" value="none"><div class="radio-label"><span class="option-title">None of the above</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-complex">Back</button><button class="btn btn-next" id="btn-next-complex">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="tech-alert">
                        <span class="box-title">Grey Areas</span>
                        These scenarios often trigger Code compliance issues (E1/E2/E3) that go beyond simple "replacement".
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepP1_Age">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Step 1c: Age & Durability</h2>
                    <div class="option-group">
                        <label><input type="radio" name="age" value="old"><div class="radio-label"><span class="option-title">Over 15 Years Old</span><span class="option-desc">Normal end of life.</span></div></label>
                        <label><input type="radio" name="age" value="young"><div class="radio-label"><span class="option-title">Under 15 Years Old</span><span class="option-desc">Premature failure.</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-age">Back</button><button class="btn btn-next" id="btn-next-age">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="info-box">
                        <span class="box-title">The 15-Year Rule</span>
                        Schedule 1 Exemptions generally do <strong>not</strong> apply if the component failed before its 15-year B2 Durability requirement.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepP2">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Step 2: Consent Status</h2>
                    <div class="option-group">
                        <label><input type="radio" name="consent_status" value="yes"><div class="radio-label"><span class="option-title">Yes, Consent Issued</span></div></label>
                        <label><input type="radio" name="consent_status" value="no_check"><div class="radio-label"><span class="option-title">Unsure / Not Confirmed</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-p2">Back</button><button class="btn btn-next" id="btn-next-p2">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="case-study-box">
                        <span class="box-title">Duty to Check</span>
                        In <em>Corbett-Pearson [2024]</em>, failing to check for a consent was deemed negligence.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepE0">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Execution: Building Type</h2>
                    <div class="option-group">
                        <label><input type="radio" name="b_type" value="residential"><div class="radio-label"><span class="option-title">Residential</span><span class="option-desc">House or small apartment.</span></div></label>
                        <label><input type="radio" name="b_type" value="commercial"><div class="radio-label"><span class="option-title">Commercial</span><span class="option-desc">Office, warehouse, industrial.</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" onclick="showStep('step0')">Back</button><button class="btn btn-next" id="btn-next-e0">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="info-box">
                        <span class="box-title">Restricted Building Work</span>
                        RBW rules specifically apply to residential buildings.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepE1">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Execution: Variations</h2>
                    <div class="option-group">
                        <label><input type="radio" name="variation" value="yes"><div class="radio-label"><span class="option-title">Yes</span><span class="option-desc">Deviating from plans.</span></div></label>
                        <label><input type="radio" name="variation" value="no"><div class="radio-label"><span class="option-title">No</span><span class="option-desc">Following plans exactly.</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-e1">Back</button><button class="btn btn-next" id="btn-next-e1">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="case-study-box">
                        <span class="box-title">Unapproved Changes</span>
                        In <em>Langdon [2025]</em>, a roofer was fined for using a "better" method without prior approval.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepE1_Discovery">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Execution: Discovery</h2>
                    <p><strong>Have you found non-compliant structure?</strong></p>
                    <div class="option-group">
                        <label><input type="radio" name="discovery" value="structural"><div class="radio-label"><span class="option-title">Yes</span><span class="option-desc">Rotten timber, wrong fixings, old ply.</span></div></label>
                        <label><input type="radio" name="discovery" value="none"><div class="radio-label"><span class="option-title">No</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-discovery">Back</button><button class="btn btn-next" id="btn-next-discovery">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="tech-alert">
                        <span class="box-title">Structural Upgrade</span>
                        New work must meet current code (s112). You cannot cover up non-compliant structure.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepE2">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Execution: Supervision</h2>
                    <div class="option-group">
                        <label><input type="radio" name="supervision" value="self"><div class="radio-label"><span class="option-title">Self-Performing</span></div></label>
                        <label><input type="radio" name="supervision" value="check"><div class="radio-label"><span class="option-title">Supervising (with checks)</span></div></label>
                        <label><input type="radio" name="supervision" value="remote"><div class="radio-label"><span class="option-title">Remote / No Checks</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-e2">Back</button><button class="btn btn-next" id="btn-next-e2">Next</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="case-study-box">
                        <span class="box-title">Remote Supervision</span>
                        In <em>Horrack [2024]</em>, the Board ruled "Remote supervision does not mean NO supervision".
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepE3">
            <div class="card-grid">
                <div class="card-main">
                    <h2>Execution: Completion</h2>
                    <div class="option-group">
                        <label><input type="radio" name="completion" value="finished"><div class="radio-label"><span class="option-title">Job Completed</span></div></label>
                        <label><input type="radio" name="completion" value="dispute"><div class="radio-label"><span class="option-title">Dispute / Payment Issue</span></div></label>
                        <label><input type="radio" name="completion" value="terminated"><div class="radio-label"><span class="option-title">Terminated / Walked Off</span></div></label>
                    </div>
                    <div class="actions"><button class="btn btn-back" id="btn-back-e3">Back</button><button class="btn btn-next" id="btn-next-e3">Get Result</button></div>
                </div>
                <div class="card-sidebar">
                    <div class="warning-box">
                        <span class="box-title">Withholding Paperwork</span>
                        In <em>Moyes [2025]</em>, an LBP was fined for withholding a RoW due to unpaid invoices.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="stepResults">
            <div class="result-block">
                <div id="result-banner" class="result-banner"></div>
                <h3>Checklist</h3>
                <ul class="checklist" id="final-checklist"></ul>
                <div id="warnings-section"></div>
                
                <div class="leg-breakdown">
                    <h3 style="margin-top:0;">Legislation Breakdown</h3>
                    <div id="legislation-breakdown"></div>
                </div>

                <div class="actions" style="grid-template-columns: 1fr;">
                    <button class="btn btn-back" onclick="location.reload()">Start New Assessment</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var state = { pathway:null, scope:null, complex:null, age:null, consent_status:null, b_type:null, variation:null, discovery:null, supervision:null, completion:null };

        // Terms
        var termsCheck = document.getElementById('terms-check');
        var startBtn = document.getElementById('btn-intro-start');
        termsCheck.addEventListener('change', function() { startBtn.disabled = !this.checked; });

        // EXPLANATIONS (No Links)
        const explanations = {
            scope: { question: "Scope", new: {ref:"Section 40", text:"New builds generally require consent."}, replace_same: {ref:"Schedule 1", text:"Exemption 1 covers like-for-like."}, replace_change: {ref:"Newton [2023]", text:"Design changes void exemptions."} },
            complex: { question: "Complexity", gutter: {ref:"E1/E2", text:"Gutter conversion alters drainage design."}, skillion: {ref:"H1/E3", text:"Skillion risks condensation."} },
            age: { question: "15-Year Rule", young: {ref:"Clause 1(a)(ii)", text:"No exemption if failed <15 years."}, old: {ref:"Schedule 1", text:"Maintenance exemption applies."} },
            consent_status: { question: "Consent Check", no_check: {ref:"Corbett-Pearson", text:"Failing to check consent is negligence."} },
            b_type: { question: "Building Type", residential: {ref:"RBW Order 2011", text:"RBW applies to residential."}, commercial: {ref:"Building Act", text:"Commercial is not RBW."} },
            variation: { question: "Variation", yes: {ref:"Langdon [2025]", text:"Unapproved variations are fines."} },
            discovery: { question: "Structure", structural: {ref:"Section 112", text:"New work must meet current code."} },
            supervision: { question: "Supervision", remote: {ref:"Horrack [2024]", text:"Must physically inspect."} },
            completion: { question: "Completion", dispute: {ref:"Moyes [2025]", text:"Withholding RoW is illegal."}, terminated: {ref:"McKinstry [2023]", text:"Completion = End of contract."} }
        };

        function showStep(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- HANDLERS ---
        document.getElementById('btn-intro-start').addEventListener('click', () => showStep('step0'));
        document.getElementById('btn-back-0').addEventListener('click', () => showStep('stepIntro'));
        document.getElementById('btn-start').addEventListener('click', () => {
            state.pathway = document.querySelector('input[name="pathway"]:checked')?.value;
            if(!state.pathway) return alert("Select pathway");
            showStep(state.pathway === 'planning' ? 'stepP1' : 'stepE0');
        });

        // Planning
        document.getElementById('btn-back-p1').addEventListener('click', () => showStep('step0'));
        document.getElementById('btn-next-p1').addEventListener('click', () => {
            state.scope = document.querySelector('input[name="scope"]:checked')?.value;
            if(!state.scope) return alert("Select scope");
            showStep('stepP1_Complex');
        });
        document.getElementById('btn-back-complex').addEventListener('click', () => showStep('stepP1'));
        document.getElementById('btn-next-complex').addEventListener('click', () => {
            state.complex = document.querySelector('input[name="complex"]:checked')?.value;
            if(!state.complex) return alert("Select option");
            showStep(state.scope === 'replace_same' ? 'stepP1_Age' : 'stepP2');
        });
        document.getElementById('btn-back-age').addEventListener('click', () => showStep('stepP1_Complex'));
        document.getElementById('btn-next-age').addEventListener('click', () => {
            state.age = document.querySelector('input[name="age"]:checked')?.value;
            if(!state.age) return alert("Select age");
            showStep('stepP2');
        });
        document.getElementById('btn-back-p2').addEventListener('click', () => showStep(state.scope === 'replace_same' ? 'stepP1_Age' : 'stepP1_Complex'));
        document.getElementById('btn-next-p2').addEventListener('click', () => {
            state.consent_status = document.querySelector('input[name="consent_status"]:checked')?.value;
            if(!state.consent_status) return alert("Confirm status");
            calcPlanning();
        });

        // Execution
        document.getElementById('btn-next-e0').addEventListener('click', () => {
            state.b_type = document.querySelector('input[name="b_type"]:checked')?.value;
            if(!state.b_type) return alert("Select type");
            showStep('stepE1');
        });
        document.getElementById('btn-back-e1').addEventListener('click', () => showStep('stepE0'));
        document.getElementById('btn-next-e1').addEventListener('click', () => {
            state.variation = document.querySelector('input[name="variation"]:checked')?.value;
            if(!state.variation) return alert("Answer variation");
            showStep('stepE1_Discovery');
        });
        document.getElementById('btn-back-discovery').addEventListener('click', () => showStep('stepE1'));
        document.getElementById('btn-next-discovery').addEventListener('click', () => {
            state.discovery = document.querySelector('input[name="discovery"]:checked')?.value;
            if(!state.discovery) return alert("Answer discovery");
            showStep('stepE2');
        });
        document.getElementById('btn-back-e2').addEventListener('click', () => showStep('stepE1_Discovery'));
        document.getElementById('btn-next-e2').addEventListener('click', () => {
            state.supervision = document.querySelector('input[name="supervision"]:checked')?.value;
            if(!state.supervision) return alert("Answer supervision");
            showStep('stepE3');
        });
        document.getElementById('btn-back-e3').addEventListener('click', () => showStep('stepE2'));
        document.getElementById('btn-next-e3').addEventListener('click', () => {
            state.completion = document.querySelector('input[name="completion"]:checked')?.value;
            if(!state.completion) return alert("Answer completion");
            calcExecution();
        });

        function renderLeg(keys) {
            let html = "";
            keys.forEach(k => {
                let v = state[k];
                if(v && explanations[k] && explanations[k][v]) {
                    html += `<div class="leg-item"><div class="leg-q">${explanations[k].question}</div><div class="leg-a"><strong>${explanations[k][v].ref}:</strong> ${explanations[k][v].text}</div></div>`;
                }
            });
            document.getElementById('legislation-breakdown').innerHTML = html;
        }

        function calcPlanning() {
            let reasons=[], warnings=[], isReq=false;
            if(state.complex!=='none') isReq=true;
            if(state.scope!=='replace_same') isReq=true;
            if(state.age==='young') isReq=true;

            let banner = document.getElementById('result-banner');
            if(isReq) {
                banner.className="result-banner res-consent";
                banner.innerHTML="<h1>CONSENT & LBP REQUIRED</h1>";
            } else {
                banner.className="result-banner res-exempt";
                banner.innerHTML="<h1>LIKELY EXEMPT</h1>";
            }
            
            if(isReq) reasons.push("LBP Required: RBW rules apply.");
            else reasons.push("No LBP Mandate (Exempt work).");

            if(state.consent_status==='no_check' && isReq) warnings.push('<div class="case-study-box"><span class="box-title">Danger</span>Check consent immediately (Corbett-Pearson).</div>');

            document.getElementById('final-checklist').innerHTML = reasons.map(r=>"<li>"+r+"</li>").join('');
            document.getElementById('warnings-section').innerHTML = warnings.join('');
            renderLeg(['scope','complex','age','consent_status']);
            showStep('stepResults');
        }

        function calcExecution() {
            let reasons=[], warnings=[];
            let banner = document.getElementById('result-banner');
            
            if(state.b_type === 'commercial') {
                banner.className="result-banner res-commercial";
                banner.innerHTML="<h1>COMMERCIAL: LBP NOT MANDATED</h1>";
                reasons.push("Commercial work is generally not RBW.");
            } else {
                if(state.discovery==='structural') {
                    banner.className="result-banner res-consent";
                    banner.innerHTML="<h1>LBP REQUIRED</h1><p>Structural Work</p>";
                } else {
                    banner.className="result-banner res-consent";
                    banner.innerHTML="<h1>LBP REQUIRED</h1><p>Residential Roofing</p>";
                }
                reasons.push("Residential roofing is RBW. LBP Supervision required.");
            }

            if(state.variation==='yes') warnings.push('<div class="case-study-box"><span class="box-title">Variation Risk</span>Get Form 45A approval (Langdon).</div>');
            if(state.supervision==='remote') warnings.push('<div class="case-study-box"><span class="box-title">Supervision Risk</span>Inspect physically (Horrack).</div>');
            if(state.completion==='dispute') warnings.push('<div class="case-study-box"><span class="box-title">Record of Work</span>Issue RoW immediately (Moyes).</div>');

            if(state.b_type==='residential') reasons.push("Send RoW to Owner & Council.");

            document.getElementById('final-checklist').innerHTML = reasons.map(r=>"<li>"+r+"</li>").join('');
            document.getElementById('warnings-section').innerHTML = warnings.join('');
            renderLeg(['b_type','variation','discovery','supervision','completion']);
            showStep('stepResults');
        }
    });
</script>

</body>
</html>
